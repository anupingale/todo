<!DOCTYPE html>
<html>

<head>
  <title>TODO</title>
  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
</head>

<body>
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span id="btnCloseModal" class="close">&times;</span>
      <div>
        <span id="taskOperation"></span>
        <span style="visibility: hidden;" id="spanTodoId"></span>
        <span style="visibility: hidden;" id="spanTaskId"></span>
        <input type="text" id="editTask">
        <input type="submit" id="btnSubmitModal">
      </div>
    </div>
  </div>

  <div id="content" class="todo-item"></div>
  <div>
    Add a new todo
    <input type="text" id="todo_title">
    <input type="text" id="todo_description">
    <input type="submit" onclick="addTodo()">
  </div>

  <div>
    Edit a new todo
    <input type="text" id="todo_edit_id">
    <input type="text" id="todo_edit_title">
    <input type="text" id="todo_edit_description">
    <input type="submit" onclick="editTodo()">
  </div>
</body>

<script>

  const toggleTaskStatus = function (event) {
    let taskId = event.target.id.replace('task_done_', '');
    let todoId = event.target.parentElement.parentElement.id.replace('container_', '');
    fetch('/toggleTaskStatus', { method: 'POST', body: JSON.stringify({ todoId, taskId }) });
    loadTodo();
  }

  const deleteTodoTask = function (event) {
    let taskId = event.target.id.replace('task_delete_', '');
    let todoId = event.target.parentElement.parentElement.id.replace('container_', '');
    fetch('/deleteTodoTask', { method: 'POST', body: JSON.stringify({ todoId, taskId }) });
    loadTodo();
  }

  const openModal = function (modalDescription, clickHandler) {
    let taskId = event.target.id.replace('task_edit_', '');
    let todoId = event.target.parentElement.parentElement.id.replace('container_', '');
    document.getElementById('spanTodoId').innerHTML = todoId;
    document.getElementById('spanTaskId').innerHTML = taskId;
    document.getElementById('taskOperation').innerHTML = modalDescription
    document.getElementById('btnSubmitModal').onclick = function () { clickHandler() }
    document.getElementById('myModal').style.display = 'block';
    document.getElementById('editTask').focus();
    document.getElementById('editTask').value = '';
  }

  const openTaskEditModal = function (event) {
    openModal('Edit Task', editTodoTask);
  }

  const openAddTaskModal = function (event) {
    openModal('Add Task', addTodoTask);
  }

  const editTodoTask = function () {
    document.getElementById('myModal').style.display = 'none';
    const taskDescription = document.getElementById('editTask').value;
    const taskId = document.getElementById('spanTaskId').innerHTML;
    const todoId = document.getElementById('spanTodoId').innerHTML;
    fetch('/editTodoTask', { method: 'POST', body: JSON.stringify({ todoId, taskId, taskDescription }) });
    loadTodo();
  }

  const addTodoTask = function () {
    document.getElementById('myModal').style.display = 'none';
    const todoId = document.getElementById('spanTodoId').innerHTML;
    const taskDescription = document.getElementById('editTask').value;
    fetch('/addTodoTask', { method: 'POST', body: JSON.stringify({ todoId, taskDescription }) });
    loadTodo();
  }

  const deleteTodo = function (event) {
    let todoId = event.target.parentElement.parentElement.id.replace('container_', '');
    fetch('/deleteUserTodo', { method: 'POST', body: JSON.stringify({ todoId }) });
    loadTodo();
  }

  const addTodo = function () {
    const title = document.getElementById('todo_title').value;
    const description = document.getElementById('todo_description').value;
    fetch('/addUserTodo', { method: 'POST', body: JSON.stringify({ title, description }) });
    loadTodo();
  }

  const editTodo = function () {
    const title = document.getElementById('todo_edit_title').value;
    const id = document.getElementById('todo_edit_id').value;
    const description = document.getElementById('todo_edit_description').value;
    fetch('/editUserTodo', { method: 'POST', body: JSON.stringify({ id, title, description }) });
    loadTodo();
  }

  const loadTodo = function () {
    document.getElementById('content').innerHTML = '';
    fetch('/loadTodoList').then(res => res.json())
      .then(text => displayTodo(text));
  }

  const operations = {
    'Add task': openAddTaskModal,
    'Edit': openTaskEditModal,
    'Delete': deleteTodoTask,
    'Done': toggleTaskStatus,
    'Undone': toggleTaskStatus,
    'Delete Todo': deleteTodo
  }

  const createButton = function (buttonName, id = '') {
    const button = document.createElement('input');
    button.type = 'button';
    button.value = buttonName;
    button.id = id;
    button.onclick = function (event) {
      operations[buttonName](event);
    }
    return button;
  }

  const createTaskToggleButton = function (done) {
    const btnTaskStatus = document.createElement('div');
    let statusButtonName = 'Done';
    btnTaskStatus.className = 'task-status-red';
    if (done) {
      statusButtonName = 'Undone';
      btnTaskStatus.className = 'task-status-green';
    }
    return { btnTaskStatus, statusButtonName };
  }

  const createTaskDescription = function (value) {
    const taskDescription = document.createElement('div');
    taskDescription.className = 'tasks';
    taskDescription.innerHTML = value;
    return taskDescription;
  }

  const createTask = function (tasks, key) {
    let item = document.createElement('div');
    item.className = 'item';
    const taskDescription = createTaskDescription(tasks[key].description);
    const { btnTaskStatus, statusButtonName } = createTaskToggleButton(tasks[key].status);
    item.appendChild(btnTaskStatus);
    item.appendChild(taskDescription);
    item.appendChild(createButton('Edit', 'task_edit_' + key));
    item.appendChild(createButton('Delete', 'task_delete_' + key));
    item.appendChild(createButton(statusButtonName, 'task_done_' + key));
    return item;
  }

  const createTitle = function (titleName) {
    const title = document.createElement('div');
    title.className = 'title';
    title.innerHTML = titleName;
    return title;
  }

  const createTitleBar = function (todoTitle) {
    const titleBar = document.createElement('div');
    titleBar.className = 'title-Bar';
    let title = createTitle(todoTitle);
    const btnAddTask = createButton('Add task');
    const btnDeleteTodo = createButton('Delete Todo');
    titleBar.appendChild(title);
    titleBar.appendChild(btnAddTask);
    titleBar.appendChild(btnDeleteTodo);
    return titleBar;
  }

  const createContainer = function (todoLists, todoListKey) {
    const container = document.createElement('div');
    container.className = 'container';
    container.id = 'container_' + todoListKey;

    const titleBar = createTitleBar(todoLists.title);
    container.appendChild(titleBar);

    const description = document.createElement('div');
    description.innerHTML = todoLists.description;
    container.appendChild(description);
    return container;
  }

  const createTodoDiv = function (todoLists, todoListKey) {
    const container = createContainer(todoLists[todoListKey], todoListKey);
    const tasks = todoLists[todoListKey].tasks;
    const taskKeys = Object.keys(tasks);

    taskKeys.forEach(key => {
      const task = createTask(tasks, key);
      container.appendChild(task);
    });
    return container;
  }

  const displayTodo = function (todoLists) {
    const todoListKeys = Object.keys(todoLists);
    todoListKeys.forEach(todoListKey => {
      const todoContainer = createTodoDiv(todoLists, todoListKey);
      document.getElementById('content').appendChild(todoContainer);
    });
  }

  const initialize = function () {
    document.getElementById('btnCloseModal').onclick = () => {
      document.getElementById('myModal').style.display = 'none';
    }
  }
  window.onload = () => { loadTodo(); initialize(); };

</script>